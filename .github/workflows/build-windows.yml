name: Build Windows EXE

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies (robust)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller
          pip install PyQt5==5.15.9
        shell: pwsh

      - name: Show python & pip versions
        run: |
          python --version
          pip --version
        shell: pwsh

      - name: Build single-file exe with PyInstaller (PowerShell safe)
        run: |
          # Remove old build/dist folders if they exist (PowerShell)
          if (Test-Path -Path "dist") { Remove-Item -LiteralPath "dist" -Recurse -Force }
          if (Test-Path -Path "build") { Remove-Item -LiteralPath "build" -Recurse -Force }

          # Run PyInstaller (collect PyQt data, include questions.json)
          pyinstaller --noconfirm --onefile --add-data "questions.json;." --hidden-import=PyQt5.sip --collect-all PyQt5 --name "IAF_Quiz" --windowed main.py
        shell: pwsh

      - name: List dist folder (debug)
        run: |
          if (Test-Path -Path "dist") {
            Get-ChildItem -Path dist -Recurse | Format-Table -AutoSize
          } else {
            Write-Host "dist folder not found"
            exit 0
          }
        shell: pwsh

      - name: Upload artifact (if produced)
        uses: actions/upload-artifact@v4
        with:
          name: IAF_Quiz_windows_exe
          path: dist/IAF_Quiz.exe
